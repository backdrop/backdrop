name: Functional tests
on: [push, pull_request]
jobs:
  batches:
    name: Run Simpletest in batches
    runs-on: ubuntu-18.04

    steps:
      - name: Setup MySQL and create database
        run: |
          sudo ln -s /etc/apparmor.d/usr.sbin.mysqld /etc/apparmor.d/disable/
          sudo apparmor_parser -R /etc/apparmor.d/usr.sbin.mysqld
          sudo mkdir /dev/shm/mysql_tmp
          sudo chown mysql:mysql /dev/shm/mysql_tmp
          sudo sed -i -e 's?datadir\s*=.*?datadir = /dev/shm/mysql?' \
            -e 's?tmpdir\s*=.*?tmpdir = /dev/shm/mysql_tmp?' /etc/mysql/mysql.conf.d/mysqld.cnf
          sudo cat /etc/mysql/mysql.conf.d/mysqld.cnf
          sudo mv /var/lib/mysql /dev/shm
          sudo systemctl start mysql.service
          sudo systemctl status mysql.service
          echo -e '[client]\nuser = root\npassword = root' > ~/.my.cnf
          cat ~/.my.cnf
          mysql -V
          mysql -e 'SHOW VARIABLES LIKE "innodb_buffer_pool%";'
