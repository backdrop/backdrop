# Configuration file for running the test suite. Results typically at http://travis-ci.org/backdrop/backdrop
language: php
php:
  - 5.3
  - 7.0
sudo: false
addons:
  apt:
    packages:
      - apache2
      - libapache2-mod-fastcgi
before_script:
  # Start PHP-FPM. There is no process manager available to start PHP-FPM on
  # Travis CI currently, so we have to locate and enable it manually.
  - cp core/misc/travis-ci/php-fpm.conf ~/.phpenv/versions/$(phpenv version-name)/etc/php-fpm.conf
  - ~/.phpenv/versions/$(phpenv version-name)/sbin/php-fpm

  # Start Apache manually on port 8080.
  - ./core/misc/travis-ci/apache2-start.sh

  # Disable XDebug to speed up execution.
  - phpenv config-rm xdebug.ini

  # Enable APC for PHP 5.3.
  - if [[ `php -v` =~ "5.3" ]]; then echo "extension = apc.so" >> core/misc/travis-ci/php.ini; fi;

  # Import the PHP configuration.
  - phpenv config-add core/misc/travis-ci/php.ini

  # Set MySQL configuration and create the database.
  - mysql -e 'SET GLOBAL wait_timeout = 5400;'
  - mysql -e 'create database backdrop;'

  # Install Backdrop with the installation script.
  - chmod a+w . settings.php
  - ./core/scripts/install.sh --db-url=mysql://travis:@127.0.0.1/backdrop
  - chmod go-w . settings.php
script: php -d display_errors="stderr" ./core/scripts/run-tests.sh --concurrency 4 --url http://localhost:8080 --color --verbose --force --all
after_failure:
  - echo "Failures detected. Outputing additional logs:"
  - cat ./core/misc/travis-ci/apache2.log
