<?php

/**
 * @file
 * Entity CRUD API tests.
 */

/**
 * Tests the basic Entity API.
 */
class EntityAPITestCase extends BackdropWebTestCase {
  function setUp() {
    parent::setUp('entity', 'entity_test');
  }

  /**
   * Tests basic CRUD functionality of the Entity API.
   */
  function testCRUD() {
    $user1 = $this->backdropCreateUser();

    // Create some test entities.
    $entity = entity_create('entity_test', array('name' => 'test', 'uid' => $user1->uid));
    $entity->save();
    $entity = entity_create('entity_test', array('name' => 'test2', 'uid' => $user1->uid));
    $entity->save();
    $entity = entity_create('entity_test', array('name' => 'test', 'uid' => NULL));
    $entity->save();

    $entities = array_values(entity_test_load_multiple(FALSE, array('name' => 'test')));

    $this->assertEqual($entities[0]->name, 'test', 'Created and loaded entity.');
    $this->assertEqual($entities[1]->name, 'test', 'Created and loaded entity.');

    // Test loading a single entity.
    $loaded_entity = entity_test_load($entity->id);
    $this->assertEqual($loaded_entity->id, $entity->id, 'Loaded a single entity by id.');

    // Test deleting an entity.
    $entities = array_values(entity_test_load_multiple(FALSE, array('name' => 'test2')));
    $entities[0]->delete();
    $entities = array_values(entity_test_load_multiple(FALSE, array('name' => 'test2')));
    $this->assertEqual($entities, array(), 'Entity deleted.');

    // Test updating an entity.
    $entities = array_values(entity_test_load_multiple(FALSE, array('name' => 'test')));
    $entities[0]->name = 'test3';
    $entities[0]->save();
    $entity = entity_test_load($entities[0]->id);
    $this->assertEqual($entity->name, 'test3', 'Entity updated.');

    // Try deleting multiple test entities by deleting all.
    $ids = array_keys(entity_test_load_multiple(FALSE));
    entity_test_delete_multiple($ids);

    $all = entity_test_load_multiple(FALSE);
    $this->assertTrue(empty($all), 'Deleted all entities.');
  }
}

/**
 * Tests Entity API base functionality.
 */
class EntityAPIInfoTestCase extends BackdropWebTestCase  {
  /**
   * Ensures entity info cache is updated after changes.
   */
  function testEntityInfoChanges() {
    module_enable(array('entity_cache_test'));
    $entity_info = entity_get_info();
    $this->assertTrue(isset($entity_info['entity_cache_test']), 'Test entity type found.');

    // Change the label of the test entity type and make sure changes appear
    // after flushing caches.
    state_set('entity_cache_test_label', 'New label.');
    backdrop_flush_all_caches();
    $info = entity_get_info('entity_cache_test');
    $this->assertEqual($info['label'], 'New label.', 'New label appears in entity info.');

    // Disable the providing module and make sure the entity type is gone.
    module_disable(array('entity_cache_test', 'entity_cache_test_dependency'));
    $entity_info = entity_get_info();
    $this->assertFalse(isset($entity_info['entity_cache_test']), 'Entity type of the providing module is gone.');
  }

  /**
   * Tests entity info cache after enabling a module with a dependency on an entity providing module.
   *
   * @see entity_cache_test_watchdog()
   */
  function testEntityInfoCacheWatchdog() {
    module_enable(array('entity_cache_test'));
    $info = state_get('entity_cache_test');
    $this->assertEqual($info['label'], 'Entity Cache Test', 'Entity info label is correct.');
    $this->assertEqual($info['controller class'], 'DefaultEntityController', 'Entity controller class info is correct.');
  }
}


/**
 * Helper class for testing view mode functionality.
 */
class EntityViewModeTestHelper extends BackdropWebTestCase {
  /**
   * Overrides BackdropWebTestCase::setUp().
   */
  public function setUp(array $modules = array()) {
    $modules[] = 'entity_view_mode_test';
    parent::setUp($modules);

    // Create an administrative user.
    $this->admin_user = $this->backdropCreateUser(array(
      'administer view modes',
      'administer content types',
    ));
  }

  /**
   * Overrides BackdropWebTestCase::refreshVariables().
   *
   * Ensures that the entity and field view mode caches are cleared so they
   * can be reliably checked in the test.
   */
  protected function refreshVariables() {
    parent::refreshVariables();

    // Clear the entity and display caches.
    backdrop_static_reset('field_view_mode_settings');
    entity_info_cache_clear();
  }

  public function assertViewModeExists($entity_type, $view_mode) {
    $info = entity_get_info($entity_type);
    return $this->assertTrue(!empty($info['view modes'][$view_mode]), "View mode $view_mode found for entity type $entity_type.");
  }

  public function assertNoViewModeExists($entity_type, $view_mode) {
    $info = entity_get_info($entity_type);
    return $this->assertTrue(!isset($info['view modes'][$view_mode]), "View mode $view_mode not found for entity type $entity_type.");
  }

  public function getActualViewMode($entity_type, $bundle, $view_mode) {
    $view_mode_settings = field_view_mode_settings($entity_type, $bundle);
    return (!empty($view_mode_settings[$view_mode]['custom_settings']) ? $view_mode : 'default');
  }

  public function assertActualViewMode($entity_type, $bundle, $view_mode, $expected_view_mode) {
    $actual_view_mode = $this->getActualViewMode($entity_type, $bundle, $view_mode);
    return $this->assertIdentical($expected_view_mode, $actual_view_mode, "View mode $view_mode for entity type $entity_type and bundle $bundle actually uses view mode $actual_view_mode, expected $expected_view_mode.");
  }

  public function assertViewModeDefaultDisplay($entity_type, $bundle, $view_mode) {
    return $this->assertActualViewMode($entity_type, $bundle, $view_mode, 'default');
  }

  public function assertViewModeCustomDisplay($entity_type, $bundle, $view_mode) {
    return $this->assertActualViewMode($entity_type, $bundle, $view_mode, $view_mode);
  }
}

/**
 * Tests view mode functionality.
 */
class EntityViewModeFunctionalTest extends EntityViewModeTestHelper {
  /**
   * Tests view mode functionality.
   */
  public function testEntityViewModes() {
    $this->backdropLogin($this->admin_user);
    $this->backdropGet('admin/config/system/view-modes');
    $this->assertLinkByHref('admin/config/system/view-modes/add/node');
    $this->backdropGet('admin/config/system/view-modes/add/node');

    // @todo Set some 'default' settings under a field instance display and
    // view mode settings to test that the default settings are applied to
    // custom view modes.
    //$settings = field_bundle_settings('node', 'post');
    //$settings['extra_fields']['display']['test']['default']['testing'] = TRUE;
    //field_bundle_settings('node', 'post', $settings);
    //$settings = field_bundle_settings('node', 'page');
    //$settings['extra_fields']['display']['test']['default']['testing'] = TRUE;
    //field_bundle_settings('node', 'page', $settings);

    // Attempt to create a view mode that already is provided by core.
    $edit = array(
      'label' => 'Custom teaser',
      'machine_name' => 'teaser',
    );
    $this->backdropPost(NULL, $edit, 'Save');
    $this->assertText('The machine-readable name is already in use. It must be unique.');

    // Save a new view mode for real.
    $edit['label'] = 'Custom 1';
    $edit['machine_name'] = 'custom_1';
    $edit['enabled_bundles[post]'] = TRUE;
    $edit['enabled_bundles[page]'] = FALSE;
    $this->backdropPost(NULL, $edit, 'Save');
    $this->assertViewModeExists('node', 'custom_1');
    $this->assertViewModeCustomDisplay('node', 'post', 'custom_1');
    $this->assertViewModeDefaultDisplay('node', 'page', 'custom_1');

    // Switch the view mode from posts to pages.
    $edit = array(
      'enabled_bundles[post]' => FALSE,
      'enabled_bundles[page]' => TRUE,
    );
    $this->backdropPost('admin/config/system/view-modes/edit/node/custom_1', $edit, 'Save');
    $this->assertText('Saved the Custom 1 node view mode.');
    $this->assertViewModeExists('node', 'custom_1');
    $this->assertViewModeDefaultDisplay('node', 'post', 'custom_1');
    $this->assertViewModeCustomDisplay('node', 'page', 'custom_1');

    // Save a custom value into the view mode settings to check that when a
    // view mode's machine name is changed, that the display settings are
    // changed as well.
    //$settings = field_bundle_settings('node', 'page');
    //$settings['view_modes']['custom_1']['testing'] = TRUE;
    //$settings['extra_fields']['display']['testing']['custom_1']['custom_1']['testing'] = TRUE;
    //field_bundle_settings('node', 'page', $settings);

    // Rename the view mode's label and machine name.
    $edit = array(
      'label' => 'Custom 2',
      'machine_name' => 'custom_2',
    );
    $this->backdropPost('admin/config/system/view-modes/edit/node/custom_1', $edit, 'Save');
    $this->assertText('Saved the Custom 2 node view mode.');
    $this->assertNoViewModeExists('node', 'custom_1');
    $this->assertViewModeDefaultDisplay('node', 'post', 'custom_1');
    $this->assertViewModeDefaultDisplay('node', 'page', 'custom_1');
    $this->assertViewModeExists('node', 'custom_2');
    $this->assertViewModeDefaultDisplay('node', 'post', 'custom_2');
    $this->assertViewModeCustomDisplay('node', 'page', 'custom_2');

    // Check that our custom value was transferred to the new view mode
    // settings.
    //$settings = field_bundle_settings('node', 'page');
    //$this->assertTrue(!isset($settings['view_modes']['custom_1']) && !isset($settings['extra_fields']['display']['custom_1']));
    //$this->assertTrue(!empty($settings['view_modes']['custom_2']['testing']) && !empty($settings['extra_fields']['display']['custom_2']['testing']));

    // Delete the view mode.
    $this->backdropPost('admin/config/system/view-modes/delete/node/custom_2', array(), 'Delete');
    $this->assertText('Deleted the Custom 2 node view mode.');
    $this->assertNoViewModeExists('node', 'custom_2');
    $this->assertViewModeDefaultDisplay('node', 'post', 'custom_2');
    $this->assertViewModeDefaultDisplay('node', 'page', 'custom_2');
  }

  /**
   * Test the new entity view mode hooks.
   */
  public function testInfoHooks() {
    config_set('entity.view_modes', 'view_modes', array(
      'node' => array(
        'info_3' => array(
          'label' => t('Variable-altered view mode'),
          'custom settings' => TRUE,
        ),
      ),
      'taxonomy_term' => array(),
    ));
    $this->refreshVariables();

    $info = entity_get_info();

    // An invalid entity type in hook_entity_view_mode_info() does not pass
    // into the entity info array.
    $this->assertTrue(!isset($info['invalid-type']));

    // Test hook-provided view modes.
    $this->assertIdentical($info['node']['view modes']['info_1'], array(
      'label' => t('Hook-defined view mode #1'),
      'custom settings' => FALSE,
    ));
    $this->assertIdentical($info['node']['view modes']['info_2'], array(
      'label' => t('Hook-altered view mode'),
      'custom settings' => TRUE,
    ));
    $this->assertIdentical($info['node']['view modes']['info_3'], array(
      'label' => t('Variable-altered view mode'),
      'custom settings' => TRUE,
    ));
    $this->assertIdentical($info['taxonomy_term']['view modes']['info_1'], array(
      'label' => t('Hook-defined view mode #1'),
      'custom settings' => TRUE,
    ));

    // Test that entity view modes defined in hook_entity_info() are never
    // overridden by custom view modes.
    $this->assertIdentical($info['node']['view modes']['full'], array(
      'label' => 'Full content',
      'custom settings' => FALSE,
    ));
  }
}

/**
 * Tests view mode altering theme suggestions.
 */
class EntityViewModeSuggestionsTest extends EntityViewModeTestHelper {
  /**
   * Overrides EntityViewModeTestHelper::setUp().
   */
  public function setUp(array $modules = array()) {
    parent::setUp($modules);

    state_set('entity_view_mode_theme_output_suggestions', array('comment', 'node', 'taxonomy_term', 'user_profile'));
    backdrop_theme_rebuild();
    backdrop_static_reset('theme_get_registry');
  }

  public function testEntityTemplateSuggestions() {
    $node = $this->backdropCreateNode();
    $build = node_view($node, 'node_test');
    $actual_suggestions = theme($build['#theme'], $build);
    $expected_suggestions = array(
      'node__' . $node->nid . '__node_test',
      'node__' . $node->nid,
      'node__' . $node->type . '__node_test',
      'node__' . $node->type,
    );
    $this->assertIdentical($actual_suggestions, $expected_suggestions);

    // Rendering comments uses '#theme' => 'comment__node_type'.
    $comment_body = $this->randomName();
    $comment = entity_create('comment', array(
      'cid' => NULL,
      'nid' => $node->nid,
      'pid' => 0,
      'uid' => 0,
      'status' => COMMENT_PUBLISHED,
      'subject' => $this->randomName(),
      'language' => LANGUAGE_NONE,
      'comment_body' => array(LANGUAGE_NONE => array($comment_body)),
    ));

    comment_save($comment);
    $comment->comment_body[LANGUAGE_NONE][0] = array(
      'value' => $comment_body,
      'format' => 'filtered_html',
    );
    $build = comment_view($comment, $node, 'comment_test');
    $actual_suggestions = theme($build['#theme'], $build);
    $expected_suggestions = array(
      'comment__' . $comment->cid . '__comment_test',
      'comment__' . $comment->cid,
      'comment__' . 'comment_node_' . $node->type . '__comment_test',
      'comment__' . 'comment_node_' . $node->type,
    );
    $this->assertIdentical($actual_suggestions, $expected_suggestions);

    // Users have no bundles.
    $account = $this->admin_user;
    $build = user_view($this->admin_user, 'user_test');
    $actual_suggestions = theme($build['#theme'], $build);
    $expected_suggestions = array(
      'user__' . $account->uid . '__user_test',
      'user__' . $account->uid,
    );
    $this->assertIdentical($actual_suggestions, $expected_suggestions);

    $term = entity_create('taxonomy_term',  array(
      'name' => $this->randomName(),
      'vocabulary' => 'tags',
    ));
    taxonomy_term_save($term);
    $build = taxonomy_term_view($term, 'term_test');
    $actual_suggestions = theme($build['#theme'], $build);
    $expected_suggestions = array(
      'taxonomy_term__' . $term->tid . '__term_test',
      'taxonomy_term__' . $term->tid,
      'taxonomy_term__' . $term->vocabulary . '__term_test',
      'taxonomy_term__' . $term->vocabulary,
    );
    $this->assertIdentical($actual_suggestions, $expected_suggestions);

    // Test the proper ordering of suggestions using the custom testing
    // theme function.
    $build = array(
      '#theme' => 'entity_view_mode_test',
      '#entity_view_mode' => array(
        'entity_type' => 'test',
        'id' => 'id',
        'bundle' => 'bundle',
        'view_mode' => 'view_mode',
        'langcode' => 'xx-test',
        'has_bundles' => TRUE,
      ),
    );
    $actual_suggestions = theme($build['#theme'], $build);
    $expected_suggestions = array(
      'test__first',
      'test__id__view_mode',
      'test__id',
      'test__bundle__view_mode',
      'test__bundle',
      'test__last',
    );
    $this->assertIdentical($actual_suggestions, $expected_suggestions);
  }
}
